<!DOCTYPE html>

<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{Layout}">
    <head>
        <title>Detalle del Usuario</title>
    </head>
    <body layout:fragment="body">
        <style>
            .edit-iconfoto {
                bottom: 5px;
                right: 5px;
                border-radius: 50%;
                padding: 4px 6px;
                z-index: 10;
            }
        </style>

        <div class="container my-4">
            <div class="bg-primary text-white text-center p-4 rounded shadow">
                <h1 class="display-6 fw-bold mb-0">
                    <i class="bi bi-person"></i> Detalles del Usuario
                </h1>
            </div>
            <div class="col-2 my-4">
                <a th:href="@{/usuario}" role="button" class="btn btn-success shadow">
                    <i class="bi bi-arrow-left"></i> Regresar
                </a>
            </div>
        </div>



        <div class="container my-4">
            <div class="row g-4">

                <div class="col-12 col-md-3">
                    <div class="card shadow rounded-3">
                        <div class="text-center p-3">

                            <div class="position-relative d-inline-block">

                                <img id="previewImg"
                                     th:if="${usuario.Imagen == null}"
                                     src="https://cdn-icons-png.flaticon.com/512/219/219983.png"
                                     class="img-fluid rounded-circle border border-3 border-primary"
                                     alt="ImagenUser" style="max-width: 150px;">

                                <img id="previewImg"
                                     th:if="${usuario.Imagen != null}"
                                     th:src="'data:image/png;base64,' + ${usuario.Imagen}"
                                     class="img-fluid rounded-circle border border-3 border-primary"
                                     alt="ImagenUser" style="max-width: 150px;">

                                <!-- Icono editar dentro de la imagen -->
                                <button class="btn btn-primary btn-sm position-absolute edit-iconfoto"
                                        data-bs-toggle="modal" data-bs-target="#editarImagenModal">
                                    <i class="bi bi-pencil"></i>
                                </button>

                            </div>


                            <input type="file" id="fileInput" accept="image/*" style="display:none">


                        </div>

                        <div class="card-body" th:each="usuario: ${usuario}">
                            <h5 class="card-title text-center fw-bold mb-3" th:text="|${usuario.nombre} ${usuario.ApellidoPaterno} ${usuario.ApellidoMaterno}|"></h5>
                            <ul class="list-unstyled mb-0">
                                <li class="d-flex align-items-center mb-2">
                                    <i class="bi bi-envelope-at me-2 text-primary"></i>
                                    <span th:text="${usuario.email}"></span>
                                </li>
                                <li class="d-flex align-items-center mb-2">
                                    <i class="bi bi-telephone me-2 text-success"></i>
                                    <span th:text="${usuario.telefono}"></span>
                                </li>
                                <li class="d-flex align-items-center mb-2">
                                    <i class="bi bi-phone me-2 text-info"></i>
                                    <span th:text="${usuario.celular}"></span>
                                </li>
                                <li class="d-flex align-items-center mb-2">
                                    <i class="bi bi-person-badge me-2 text-secondary"></i>
                                    <span th:text="${usuario.username}">usuario123</span>
                                </li>

                                <li class="d-flex align-items-center mb-2">
                                    <i class="bi bi-card-text me-2 text-warning"></i>
                                    <span th:text="${usuario.Curp}"></span>
                                </li>

                                <li class="d-flex align-items-center mb-2">
                                    <i class="bi bi-gender-ambiguous me-2 text-info"></i>
                                    <span th:text="${usuario.Sexo}"></span>
                                </li>

                                <li class="d-flex align-items-center mb-2">
                                    <i class="bi bi-calendar-event me-2 text-success"></i>
                                    <span th:text="${usuario.FechaNacimiento}"></span>
                                </li>

                                <li class="d-flex align-items-center">
                                    <i class="bi bi-person-vcard me-2 text-secondary"></i>
                                    <span th:text="${usuario.Rol.Nombre}"></span>
                                </li>
                            </ul>
                            <div class="text-end">
                                <button class="btn btn-primary shadow" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editarUsuarioModal">
                                    Editar <i class="bi bi-pencil-square"></i>
                                </button>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="editarUsuarioModal" tabindex="-1" aria-labelledby="editarUsuarioModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content shadow-lg border-0 rounded-4">

                            <div class="modal-header bg-primary text-white rounded-top-4">
                                <h5 class="modal-title fw-bold" id="editarUsuarioModalLabel">
                                    <i class="bi bi-person-lines-fill me-2"></i>Editar Información del Usuario
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                            </div>

                            <div class="modal-body bg-light">
                                <form th:object="${usuario}" th:action="@{detail}" method="post" id="formEditarUsuario">
                                    <input type="hidden" th:field="*{IdUsuario}">

                                    <div class="border-bottom pb-2 mb-3">
                                        <h6 class="fw-semibold text-primary mb-3">Datos Personales</h6>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="nombre" class="form-label fw-medium">Nombre</label>
                                                <input th:field="*{Nombre}" type="text" class="form-control" id="nombre" name="nombre" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="apellidoPaterno" class="form-label fw-medium">Apellido Paterno</label>
                                                <input th:field="*{ApellidoPaterno}"  type="text" class="form-control" id="apellidoPaterno" name="apellidoPaterno" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="apellidoMaterno" class="form-label fw-medium">Apellido Materno</label>
                                                <input th:field="*{ApellidoMaterno}" type="text" class="form-control" id="apellidoMaterno" name="apellidoMaterno" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="curp" class="form-label fw-medium">CURP</label>
                                                <input th:field="*{Curp}" type="text" class="form-control text-uppercase" id="curp" name="curp" required maxlength="18">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="sexo" class="form-label fw-medium">Sexo</label>
                                                <select th:field="*{Sexo}" class="form-select" id="sexo" name="sexo" required>
                                                    <option value=0>Seleccionar...</option>
                                                    <option value="M">Masculino</option>
                                                    <option value="F">Femenino</option>
                                                    <option value="SE">Otro</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="fechaNacimiento" class="form-label fw-medium">Fecha de Nacimiento</label>
                                                <input th:field="*{FechaNacimiento}" type="date" class="form-control" id="fechaNacimiento" name="fechaNacimiento" required>
                                            </div>

                                            <div class="col-12 col-md-6">
                                                <label class="form-label fw-medium">Rol</label>
                                                <select th:field="*{Rol.IdRol}" class="form-select" id="rol" name="rol" >
                                                    <option value=0>Seleccione Rol</option>
                                                    <option th:each="rol: ${roles}" th:value="${rol.IdRol}" th:text="${rol.Nombre}"></option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="border-bottom pb-2 mb-3">
                                        <h6 class="fw-semibold text-primary mb-3">Contacto</h6>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="email" class="form-label fw-medium">Correo Electrónico</label>
                                                <input th:field="*{Email}" type="email" class="form-control" id="email" name="email" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="username" class="form-label fw-medium">Usuario</label>
                                                <input th:field="*{Username}" type="text" class="form-control" id="username" name="username" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="celular" class="form-label fw-medium">Celular</label>
                                                <input th:field="*{celular}" type="tel" class="form-control" id="celular" name="celular" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="telefono" class="form-label fw-medium">Teléfono</label>
                                                <input th:field="*{telefono}"  type="tel" class="form-control" id="telefono" name="telefono">
                                            </div>

                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="modal-footer bg-light rounded-bottom-4">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-1"></i>Cancelar
                                </button>
                                <button type="submit" form="formEditarUsuario" class="btn btn-primary">
                                    <i class="bi bi-save me-1"></i>Guardar Cambios
                                </button>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="col-12 col-md-9">
                    <div class="col-2 my-2 ms-auto">
                        <button id="btnAgregarDireccion" type="button" class="btn btn-secondary shadow">
                            <i class="bi bi-plus-circle"></i> Agregar Dirección
                        </button>
                    </div>
                    <table class="table table-hover table-striped table-bordered border-2 border-dark shadow-sm rounded-3 caption-top align-middle">
                        <caption><i class="bi bi-geo-alt-fill"></i> Direcciones</caption>
                        <thead class="bg-primary text-white text-center">
                            <tr>
                                <th class='col-3' scope="col">Direccion</th>                            
                                <th class='col-1' scope="col">C.P.</th>                                
                                <th class='col-2' scope="col">Colonia</th>
                                <th class='col-2' scope="col">Municipio</th>
                                <th class='col-2' scope="col">Estado</th>
                                <th  class='col-1' scope="col">Pais</th>                                
                                <th class='col-1' scope="col">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="table-light text-center">
                            <tr th:each="direccion: ${usuario.Direcciones}">
                                <td th:text="|${direccion.Calle} ${direccion.NumeroExterior} No. Int: ${direccion.NumeroInterior}"></td>
                                <td th:text='${direccion.Colonia.CodigoPostal}'></td>
                                <td th:text='${direccion.Colonia.Nombre}'></td>
                                <td th:text='${direccion.Colonia.Municipio.Nombre}'></td>
                                <td th:text='${direccion.Colonia.Municipio.Estado.Nombre}'></td>
                                <td th:text='${direccion.Colonia.Municipio.Estado.Pais.Nombre}'></td>
                                <td>
                                    <!-- Esta IdDireccion <span th:text="${direccion.idDireccion}" ></span>-->
                                    <button th:data-idDireccion="${direccion.idDireccion}" class="btn btn-warning btn-sm me-2 editDireccionBtn">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>

                                    <button type="button" class="btn btn-danger btn-sm deleteDireccionBtn"
                                            th:data-idDireccion="${direccion.idDireccion}"
                                            th:data-idUsuario="${usuario.IdUsuario}">
                                        <i class="bi bi-trash"></i>
                                    </button>

                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="modal fade" id="direccionModal" tabindex="-1" aria-labelledby="direccionModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content shadow-lg border-0 rounded-4">
                            <div class="modal-header bg-primary text-white rounded-top-4">
                                <h5 class="modal-title fw-bold" id="direccionModalLabel">
                                    <i class="bi bi-geo-alt-fill me-2"></i><span id="tituloModalDireccion">Agregar Dirección</span>
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>

                            <div class="modal-body bg-light">
                                
                                
                                <!--Este es el Id 0 de la direccion = <p th:text="${Direccion.IdDireccion}"></p>-->
                                
                                
                                <form th:object="${Direccion}" id="formDireccion" th:action="@{addDireccion/{idUsuario}(idUsuario = ${usuario.IdUsuario})}" method="post">
                                    <!--<input type="hidden" name="IdUsuario" th:value="${usuario.IdUsuario}">--> 
                                    <input type="hidden" id="idDireccion" name="idDireccion" th:field="*{IdDireccion}">

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label for="calle" class="form-label fw-medium">Calle</label>
                                            <input th:field="*{Calle}" type="text" class="form-control" id="calle" name="calle" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="numeroExterior" class="form-label fw-medium">Número Exterior</label>
                                            <input th:field="*{NumeroExterior}" type="text" class="form-control" id="numeroExterior" name="numeroExterior" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="numeroInterior" class="form-label fw-medium">Número Interior</label>
                                            <input th:field="*{NumeroInterior}" type="text" class="form-control" id="numeroInterior" name="numeroInterior">
                                        </div>

                                        <div class="col-md-6">
                                            <label for="ddlpais" class="form-label fw-bold">Pais</label>
                                            <select id="ddlpais" th:field="${Direccion.Colonia.Municipio.Estado.Pais.IdPais}" class="form-select">
                                                <option value=0>Seleccione Pais</option>
                                                <option th:each="pais : ${paises}" th:value="${pais.IdPais}" th:text="${pais.Nombre}"></option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="ddlestado" class="form-label fw-bold">Estado</label>
                                            <select th:field="${Direccion.Colonia.Municipio.Estado.IdEstado}" id="ddlestado" class="form-select" aria-label="Default select example" >
                                                <option value=0 selected>Selecciona un Estado</option>
                                                <option th:each="estado : ${estados}" th:value="${estado.IdEstado}" th:text="${estado.Nombre}">Selecciona un Estado</option>
                                            </select>
                                        </div>

                                        <div class="col-md-6">
                                            <label for="ddlmunicipio" class="form-label fw-bold">Municipio</label>
                                            <select th:field="${Direccion.Colonia.Municipio.IdMunicipio}" id="ddlmunicipio" class="form-select" aria-label="Default select example" >
                                                <option value=0 selected>Selecciona un municipio</option>
                                                <option th:each="municipio : ${municipios}" th:value="${municipio.IdMunicipio}" th:text="${municipio.Nombre}">Selecciona un Municipio</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="ddlcolonia" class="form-label fw-bold">Colonia</label>
                                            <select th:field="${Direccion.Colonia.IdColonia}" id="ddlcolonia" class="form-select" aria-label="Default select example" >
                                                <option value=0 selected>Selecciona una colonia </option>
                                                <option th:each="colonia : ${colonias}" th:value="${colonia.IdColonia}" th:text="${colonia.Nombre}">Selecciona una Colonia</option>
                                            </select>
                                        </div>

                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">Codigo Postal</label>
                                            <input type="text" id="txtcp" class="form-control" placeholder="Codigo Postal" th:field="*{Colonia.CodigoPostal}">
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="modal-footer bg-light rounded-bottom-4">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x-circle me-1"></i>Cancelar
                                </button>
                                <button type="submit" form="formDireccion" class="btn btn-primary">
                                    <i class="bi bi-save me-1"></i><span id="textoBotonDireccion">Guardar Dirección</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!--Modal de la foto-->
        <div class="modal fade" id="editarImagenModal" tabindex="-1" aria-labelledby="editarImagenModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">

                    <div class="modal-header">
                        <h5 class="modal-title">Actualizar Imagen</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="detenerCamara()"></button>
                    </div>

                    <div class="modal-body">

                        <div class="d-flex flex-column align-items-center">

                            <img id="previewModal"
                                 src=""
                                 class="img-fluid rounded-circle border border-2 mb-3 shadow"
                                 style="max-width:150px; display:none;">

                            <div id="cameraContainer" class="text-center" style="display:none;">
                                <video id="video"
                                       autoplay
                                       width="220"
                                       class="border border-3 rounded shadow-sm mb-2"></video><br>

                                <canvas id="canvas"
                                        width="200" height="200"
                                        class="rounded-circle border border-2 shadow-sm mb-2"
                                        style="display:none;"></canvas>

                                <button class="btn btn-danger btn-sm" onclick="capturarFoto()">Capturar</button>
                                <button class="btn btn-secondary btn-sm" onclick="detenerCamara()">Cerrar cámara</button>
                            </div>

                            <!-- Input real -->
                            <input type="file" id="fileInput" accept="image/*" class="form-control mt-3" style="display:none">

                            <!-- Botones de acción -->
                            <div class="mt-3">
                                <button class="btn btn-primary btn-sm" onclick="document.getElementById('fileInput').click()">
                                    Cargar desde archivo
                                </button>
                                <button class="btn btn-success btn-sm" onclick="activarCamara()">
                                    Tomar foto
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="detenerCamara()" data-bs-dismiss="modal">Cancelar</button>
                        <button class="btn btn-success" onclick="guardarImagen()">Guardar</button>
                    </div>

                </div>
            </div>
        </div>

        <script th:if="${successMessage}" th:inline="javascript">
            Swal.fire({
            title: [[${successMessage}]],
                    icon: "success",
                    draggable: true
            });
        </script>
        <script th:if="${errorMessage}" th:inline="javascript">
            Swal.fire({
            icon: "error",
                    title: "No se actualizo",
                    text: "Revisa los campos!"
            });
        </script>

        <script th:if="${resultAdd}" th:inline="javascript">
            if ([[${resultAdd.correct}]] == true){
            Swal.fire({
            title: [[${successMessage}]],
                    text: "Se agrego la dirección correctamente."
                    icon: "success",
                    draggable: true
            });
            } else{

            }
        </script>

        <script>
            const fileInput = document.getElementById("fileInput");
            const previewImg = document.getElementById("previewImg");
            const previewModal = document.getElementById("previewModal");
            const cameraContainer = document.getElementById("cameraContainer");
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            let stream = null;
            let imagenBase64 = "";
            // ---- Cargar imagen desde archivo ----
            fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;
            // Si abro archivo, apago cámara
            detenerCamara();
            cameraContainer.style.display = "none";
            if (!file.type.startsWith("image/")) {
            Swal.fire({
            icon: "error",
                    title: "Archivo no válido",
                    text: "Solo se permiten imágenes (JPG, PNG, etc).",
                    confirmButtonText: "Entendido"
            });
            fileInput.value = "";
            return;
            }

            const reader = new FileReader();
            reader.onload = () => {
            previewModal.style.display = "block";
            previewModal.src = reader.result;
            imagenBase64 = reader.result;
            };
            reader.readAsDataURL(file);
            });
            // ---- Activar cámara ----
            async function activarCamara() {

            // Si abro cámara, borro imagen previa cargada
            previewModal.src = "";
            previewModal.style.display = "none";
            fileInput.value = "";
            cameraContainer.style.display = "block";
            try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            } catch (error) {
            Swal.fire("Error", "No se pudo acceder a la cámara", "error");
            }
            }

            // ---- Detener cámara ----
            function detenerCamara() {
            if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
            }
            cameraContainer.style.display = "none";
            }

            // ---- Capturar foto ----
            function capturarFoto() {
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            imagenBase64 = canvas.toDataURL("image/png");
            previewModal.style.display = "block";
            previewModal.src = imagenBase64;
            detenerCamara();
            }

            function guardarImagen() {if (!imagenBase64) {
            Swal.fire("Sin imagen", "Debes cargar o tomar una foto.", "warning");
            return;
            }

            $.ajax({
            url: "/usuario/imagen/update",
                    type: "POST",
                    data: {
                    idUsuario: [[${usuario.IdUsuario}]],
                            imagen: imagenBase64
                    },
                    success: function (data) {
                    previewImg.src = imagenBase64;
                    detenerCamara();
                    const modal = document.getElementById("editarImagenModal");
                    modal.addEventListener('hidden.bs.modal', () => {
                    Swal.fire("Éxito", "Imagen guardada correctamente", "success");
                    }, { once: true });
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    modalInstance.hide();
                    },
                    error: function () {
                    Swal.fire("Error", "No se pudo guardar la imagen", "error");
                    }
            });
            }
        </script>



        <script>
            $(document).ready(function () {

            $(".deleteDireccionBtn").click(function () {
            Swal.fire({
            title: "¿Deseas borrar esta dirección?",
                    text: "No podrás deshacer esta acción",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#3085d6",
                    cancelButtonColor: "#d33",
                    confirmButtonText: "Sí, borrar"
            }).then((result) => {
            if (result.isConfirmed) {

            let idDireccion = $(this).attr("data-idDireccion");
            let idUsuario = $(this).attr("data-idUsuario");
            $.post("/usuario/deleteDireccion", {
            IdDireccion: idDireccion,
                    IdUsuario: idUsuario
            })
                    .done(function () {
                    Swal.fire(
                            "¡Eliminado!",
                            "La dirección fue eliminada correctamente.",
                            "success"
                            ).then(() => {
                    location.reload();
                    });
                    })
                    .fail(function () {
                    Swal.fire(
                            "Error",
                            "No se pudo eliminar la dirección.",
                            "error"
                            );
                    });
            }
            });
            });
            $("#btnAgregarDireccion").click(function () {
            $("#formDireccion")[0].reset();
            $("#tituloModalDireccion").text("Agregar Dirección");
            $("#textoBotonDireccion").text("Guardar Dirección");
            var direccionModal = new bootstrap.Modal(document.getElementById('direccionModal'));
            direccionModal.show();
            rebindDropDownEvents();
            });
            $(".editDireccionBtn").click(function () {
            let idDireccion = $(this).attr("data-idDireccion");
            $.ajax({
            url: "/usuario/direccion/" + idDireccion,
                    method: "GET",
                    success: function (data) {
                    $("#idDireccion").val(data.idDireccion || "");
                    $("#calle").val(data.calle || "");
                    $("#numeroExterior").val(data.numeroExterior || "");
                    $("#numeroInterior").val(data.numeroInterior || "");
                    $("#ddlpais, #ddlestado, #ddlmunicipio").off("change");
                    $("#ddlpais").val(data.colonia.municipio.estado.pais.idPais);
                    $.get("estado/" + data.colonia.municipio.estado.pais.idPais, function (estados) {
                    $("#ddlestado").empty().append("<option value=0>Selecciona</option>");
                    $.each(estados.objects, function (i, e) {
                    $("#ddlestado").append(`<option value="${e.idEstado}">${e.nombre}</option>`);
                    });
                    $("#ddlestado").val(data.colonia.municipio.estado.idEstado);
                    $.get("municipio/" + data.colonia.municipio.estado.idEstado, function (municipios) {
                    $("#ddlmunicipio").empty().append("<option value=0>Selecciona</option>");
                    $.each(municipios.objects, function (i, m) {
                    $("#ddlmunicipio").append(`<option value="${m.idMunicipio}">${m.nombre}</option>`);
                    });
                    $("#ddlmunicipio").val(data.colonia.municipio.idMunicipio);
                    $.get("colonia/" + data.colonia.municipio.idMunicipio, function (colonias) {
                    $("#ddlcolonia").empty().append("<option value=0>Selecciona</option>");
                    $.each(colonias.objects, function (i, c) {
                    $("#ddlcolonia").append(`<option value="${c.idColonia}" data-cp="${c.codigoPostal}">${c.nombre}</option>`);
                    });
                    $("#ddlcolonia").val(data.colonia.idColonia);
                    $("#txtcp").val(data.colonia.codigoPostal);
                    rebindDropDownEvents();
                    });
                    });
                    });
                    $("#tituloModalDireccion").text("Editar Dirección");
                    $("#textoBotonDireccion").text("Actualizar Dirección");
                    var direccionModal = new bootstrap.Modal(document.getElementById('direccionModal'));
                    direccionModal.show();
                    },
                    error: function () {
                    alert("No se pudo cargar la dirección");
                    }
            });
            });
            function rebindDropDownEvents() {
            $("#ddlpais").change(function () {
            $.get("estado/" + $("#ddlpais").val(), function (data) {
            $("#ddlestado,#ddlmunicipio,#ddlcolonia").empty();
            $("#ddlestado").append("<option value=0 selected>Selecciona</option>");
            $.each(data.objects, function (i, estado) {
            $("#ddlestado").append(`<option value="${estado.idEstado}">${estado.nombre}</option>`);
            });
            });
            });
            $("#ddlestado").change(function () {
            $.get("municipio/" + $("#ddlestado").val(), function (data) {
            $("#ddlmunicipio,#ddlcolonia").empty();
            $("#ddlmunicipio").append("<option value=0 selected>Selecciona</option>");
            $.each(data.objects, function (i, municipio) {
            $("#ddlmunicipio").append(`<option value="${municipio.idMunicipio}">${municipio.nombre}</option>`);
            });
            });
            });
            $("#ddlmunicipio").change(function () {
            $.get("colonia/" + $("#ddlmunicipio").val(), function (data) {
            $("#ddlcolonia").empty();
            $("#ddlcolonia").append("<option value=0 selected>Selecciona</option>");
            $.each(data.objects, function (i, colonia) {
            $("#ddlcolonia").append(`<option value="${colonia.idColonia}" data-cp="${colonia.codigoPostal}">${colonia.nombre}</option>`);
            });
            });
            });
            $("#ddlcolonia").change(function () {
            let cp = $("#ddlcolonia option:selected").data("cp");
            $("#txtcp").val(cp || "");
            });
            }
            });


        </script>

    </body>
</html>
