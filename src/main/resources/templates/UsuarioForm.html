<!DOCTYPE html>

<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
      xmlns:th="http://www.thymeleaf.org"
      layout:decorate="~{Layout}">
    <head>
        <title>Formulario</title>
    </head>
    <body layout:fragment="body">
        <style>
            .correct {
                border-color: #28a745 !important;
                background-color: #e9fce9;
                box-shadow: 0 0 6px rgba(40, 167, 69, 0.4);
                transition: all 0.25s ease;
            }

            .error {
                border-color: #dc3545 !important;
                background-color: #ffecec;
                box-shadow: 0 0 6px rgba(220, 53, 69, 0.4);
                transition: all 0.25s ease;
            }

        </style>

        <div class="container my-4">

            <div class="bg-primary text-white text-center p-4 rounded shadow-sm mb-4">
                <h1 class="h4 fw-bold mb-0"><i class="bi bi-person"></i> Formulario de Usuario</h1>
            </div>

            <div class="col-2 my-4">
                <a th:href="@{/usuario}" role="button" class="btn btn-success shadow">
                    <i class="bi bi-arrow-left"></i> Regresar
                </a>
            </div>

            <form method="post" th:object="${Usuario}" th:action="@{add}" enctype="multipart/form-data">

                <div class="card shadow-sm rounded-3 p-3 mb-4">
                    <div class="text-center mb-3">
                        <img id="preview" src="https://cdn-icons-png.flaticon.com/512/219/219983.png"
                             alt="Foto Usuario" class="img-fluid rounded-circle mb-2" style="max-width:150px;">

                        <input id="imagenFile" name="imagenFile" type="file" accept="image/*" class="form-control">
                        <small class="text-muted">Cargar o tomar foto</small><br>

                        <button type="button" class="btn btn-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#cameraModal">
                            Tomar con cámara
                        </button>
                    </div>


                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Username</label>
                            <input th:field="*{Username}" type="text" class="form-control" placeholder="Usuario" onkeypress="isUserName(event, this)">
                            <span class="error-msg text-danger"></span>
                            <span th:if="${#fields.hasErrors('Username')}" th:errors="*{Username}" class="text-danger"></span>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Email</label>
                            <input th:field="*{Email}" type="email" class="form-control" placeholder="correo@ejemplo.com" onkeypress="isEmail(event, this)">
                            <span class="error-msg text-danger"></span>
                            <span th:if="${#fields.hasErrors('Email')}" th:errors="*{Email}" class="text-danger"></span>
                        </div>

                        <div class="col-12 col-md-4">
                            <label for="NombreUsuario" class="form-label fw-bold">Nombre</label>
                            <input id="NombreUsuario" type="text" class="form-control" placeholder="Nombre" th:field="*{Nombre}" oninput="ValidacionTexto(this)">
                            <span class="error-msg text-danger"></span>
                            <span th:if="${#fields.hasErrors('Nombre')}" th:errors="*{Nombre}" class="text-danger"></span>
                        </div>

                        <div class="col-12 col-md-4">
                            <label class="form-label fw-bold">Apellido Paterno</label>
                            <input th:field="*{ApellidoPaterno}" type="text" class="form-control" placeholder="Apellido Paterno" oninput="ValidacionTexto(this)">
                            <span class="error-msg text-danger"></span>
                            <span th:if="${#fields.hasErrors('ApellidoPaterno')}" th:errors="*{ApellidoPaterno}" class="text-danger"></span>
                        </div>

                        <div class="col-12 col-md-4">
                            <label class="form-label fw-bold">Apellido Materno</label>
                            <input th:field="*{ApellidoMaterno}" type="text" class="form-control" placeholder="Apellido Materno" oninput="ValidacionTexto(this)">
                            <span class="error-msg text-danger"></span>
                            <span th:if="${#fields.hasErrors('ApellidoMaterno')}" th:errors="*{ApellidoMaterno}" class="text-danger"></span>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Password</label>
                            <input th:field="*{Password}" type="password" class="form-control" placeholder="Contraseña" onkeypress="isPassword(event, this)">
                            <span class="error-msg text-danger"></span>
                            <span th:if="${#fields.hasErrors('Password')}" th:errors="*{Password}" class="text-danger"></span>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">CURP</label>
                            <input th:field="*{Curp}" type="text" class="form-control" placeholder="CURP" onkeypress="isCURP(event, this)">
                            <span class="error-msg text-danger"></span>
                            <span th:if="${#fields.hasErrors('Curp')}" th:errors="*{Curp}" class="text-danger"></span>
                        </div>

                        <div class="col-12 col-md-4">
                            <label class="form-label fw-bold">Fecha de Nacimiento</label>
                            <input th:field="*{FechaNacimiento}" type="date" class="form-control">
                            <span class="error-msg text-danger"></span>
                            <span th:if="${#fields.hasErrors('FechaNacimiento')}" th:errors="*{FechaNacimiento}" class="text-danger"></span>
                        </div>

                        <div class="col-12 col-md-4">
                            <label name="Sexo" class="form-label fw-bold">Sexo</label>
                            <select th:field="*{Sexo}" class="form-select">
                                <option value="">Seleccione...</option>
                                <option value="M">Masculino</option>
                                <option value="F">Femenino</option>
                                <option value="SE">Otro</option>
                            </select>
                            <span th:if="${#fields.hasErrors('Sexo')}" th:errors="*{Sexo}" class="text-danger"></span>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Teléfono</label>
                            <input th:field="*{Telefono}" type="text" class="form-control" placeholder="555-123-4567" onkeypress="SoloNumeros(event, this)">
                            <span class="error-msg text-danger"></span>
                            <span th:if="${#fields.hasErrors('Telefono')}" th:errors="*{Telefono}" class="text-danger"></span>

                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Celular</label>
                            <input th:field="*{Celular}" type="text" class="form-control" placeholder="555-987-6543" onkeypress="SoloNumeros(event, this)">
                            <span class="error-msg text-danger"></span>
                            <span th:if="${#fields.hasErrors('Celular')}" th:errors="*{Celular}" class="text-danger"></span>

                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Rol</label>
                            <select th:field="*{Rol.IdRol}" class="form-select" onchange="getval(this);">
                                <option value=0>Seleccione Rol</option>
                                <option th:each="rol: ${roles}" th:value="${rol.IdRol}" th:text="${rol.Nombre}"></option>
                            </select>
                            <span th:if="${#fields.hasErrors('Rol.IdRol')}" th:errors="*{Rol.IdRol}" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <div class="card shadow-sm rounded-3 p-3 mb-5">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0"><i class="bi bi-geo-alt-fill"></i> Direcciones</h5>
                        <button type="button" class="btn btn-success btn-sm"><i class="bi bi-plus"></i> Agregar Dirección</button>
                    </div>

                    <div class="row g-3">

                        <div class="col-12 col-md-4">
                            <label for="ddlpais" class="form-label fw-bold">Pais</label>
                            <select id="ddlpais" th:field="*{Direcciones[0].Colonia.Municipio.Estado.Pais.IdPais}" class="form-select">
                                <option value=0>Seleccione Pais</option>
                                <option th:each="pais : ${paises}" th:value="${pais.IdPais}" th:text="${pais.Nombre}"></option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label for="ddlestado" class="form-label fw-bold">Estado</label>
                            <select id="ddlestado" th:field="*{Direcciones[0].Colonia.Municipio.Estado.IdEstado}" class="form-select" aria-label="Default select example" >
                                <option value=0 selected>Selecciona un Estado</option>
                                <option th:each="estado : ${estados}" th:value="${estado.IdEstado}" th:text="${estado.Nombre}">Selecciona un Estado</option>
                            </select>
                        </div>

                        <div class="col-md-4" >
                            <label for="ddlmunicipio" class="form-label fw-bold">Municipio</label>
                            <select id="ddlmunicipio" th:field="*{Direcciones[0].Colonia.Municipio.IdMunicipio}" class="form-select" aria-label="Default select example" >
                                <option value=0 selected>Selecciona un municipio</option>
                                <option th:each="municipio : ${municipios}" th:value="${municipio.IdMunicipio}" th:text="${municipio.Nombre}">Selecciona un Municipio</option>
                            </select>
                        </div>

                        <div class="col-12 col-md-4">
                            <label class="form-label fw-bold">Codigo Postal</label>
                            <input type="text" id="txtcp" class="form-control" placeholder="Codigo Postal" th:field="*{Direcciones[0].Colonia.CodigoPostal}">
                        </div>

                        <div class="col-md-3">
                            <label for="ddlcolonia" class="form-label fw-bold">Colonia</label>
                            <select id="ddlcolonia" th:field="*{Direcciones[0].Colonia.IdColonia}" class="form-select" aria-label="Default select example" >
                                <option value=0 selected>Selecciona una colonia </option>
                                <option th:each="colonia : ${colonias}" th:value="${colonia.IdColonia}" th:text="${colonia.Nombre}">Selecciona una Colonia</option>
                            </select>
                        </div>

                        <div class="col-12 col-md-6">
                            <label class="form-label fw-bold">Calle</label>
                            <input th:field="*{Direcciones[0].Calle}" type="text" class="form-control" placeholder="Calle">
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label fw-bold">Número Interior</label>
                            <input th:field="*{Direcciones[0].NumeroInterior}" type="text" class="form-control" placeholder="Num. Interior">
                        </div>
                        <div class="col-12 col-md-3">
                            <label class="form-label fw-bold">Número Exterior</label>
                            <input th:field="*{Direcciones[0].NumeroExterior}" type="text" class="form-control" placeholder="Num. Exterior">
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end gap-2 sticky-bottom bg-white p-3 border-top">
                    <button type="reset" class="btn btn-secondary btn-lg">
                        <i class="bi bi-x-circle"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-save"></i> Guardar
                    </button>
                </div>

            </form>

            <div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">

                        <div class="modal-header">
                            <h5 class="modal-title" id="cameraModalLabel">Tomar Foto</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <div class="modal-body text-center">

                            <video id="video" autoplay playsinline class="rounded mb-3"
                                   style="max-width:100%; border:1px solid #ccc;"></video>

                            <canvas id="canvas" width="300" height="300" class="d-none"></canvas>

                            <button id="captureBtn" class="btn btn-success btn-sm">
                                Capturar
                            </button>

                        </div>

                    </div>
                </div>
            </div>


        </div>

        <script th:if="${successMessageAdd}" th:inline="javascript">
            Swal.fire({
                position: "top-end",
                icon: "success",
                title: '[[${successMessageAdd}]]',
                showConfirmButton: false,
                timer: 1500
            });
        </script>

        <script th:if="${errorMessageAdd}" th:inline="javascript">
            Swal.fire({
                icon: "error",
                title: [[${errorMessageAdd}]],
                showConfirmButton: false,
                timer: 1500
            });
        </script>

        <script th:inline="javascript" >
            document.addEventListener('DOMContentLoaded', () => {
                document.querySelectorAll('input[type=text]').forEach(node => node.addEventListener('keypress', e => {
                        if (e.keyCode == 13) {
                            e.preventDefault();
                        }
                    }))
            });
            $("#ddlpais").change(function () {
                $.ajax({
                    type: 'GET',
                    url: "estado/" + $("#ddlpais").val(),
                    datatype: "json",
                    success: function (data, textStatus, jqXHR) {

                        $("#ddlestado,#ddlmunicipio,#ddlcolonia").empty();
                        $("#ddlestado").append("<option value=0 selected>Selecciona un estado</option>");
                        $.each(data.objects, function (i, estado) {
                            $("#ddlestado").append("<option value= " + estado.idEstado + "> " + estado.nombre + "</option>");
                        });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("no hay nada por cargar :C");
                    }
                });
            });
            $("#ddlestado").change(function () {
                $.ajax({
                    type: 'GET',
                    url: "municipio/" + $("#ddlestado").val(),
                    datatype: "json",
                    success: function (data, textStatus, jqXHR) {

                        $("#ddlmunicipio,#ddlcolonia").empty();
                        $("#ddlmunicipio").append("<option value=0 selected>Selecciona un municipio</option>");
                        $.each(data.objects, function (i, municipio) {
                            $("#ddlmunicipio").append("<option value= " + municipio.idMunicipio + "> " + municipio.nombre + "</option>");
                        });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("no hay nada por cargar :C");
                    }
                });
            });
            $("#ddlmunicipio").change(function () {
                $.ajax({
                    type: 'GET',
                    url: "colonia/" + $("#ddlmunicipio").val(),
                    datatype: "json",
                    success: function (data, textStatus, jqXHR) {

                        $("#ddlcolonia").empty();
                        $("#ddlcolonia").append("<option value=0 selected>Selecciona una colonia </option>");
                        $.each(data.objects, function (i, colonia) {
                            $("#ddlcolonia").append("<option value= '" + colonia.idColonia + "' data-cp='" + colonia.codigoPostal + "' > " + colonia.nombre + "</option>");
                        });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("no hay nada por cargar :C");
                    }
                });
            });
            $("#ddlcolonia").change(function () {
                let cp = $("#ddlcolonia option:selected").data("cp");
                $("#txtcp").val(cp || "");
            });

            function ValidacionTexto(input) {
                let value = input.value;

                // Permite solo letras, espacios y acentos
                value = value.replace(/[^A-Za-zñÑáéíóúÁÉÍÓÚ ]/g, "");

                // Evita doble espacio
                value = value.replace(/\s{2,}/g, " ");

                // Evita espacio al inicio
                if (value.startsWith(" ")) {
                    value = value.trimStart();
                }

                // Evita espacio al final mientras escribe
                if (value.endsWith("  ")) {
                    value = value.trimEnd();
                }

                input.value = value;

                // Validación final del patrón
                let RegExp = /^[A-Za-zñÑáéíóúÁÉÍÓÚ]+(\s[A-Za-zñÑáéíóúÁÉÍÓÚ]+)*$/;

                if (value.length === 0) {
                    $(input).removeClass("correct").addClass("error");
                    $(input).siblings(".error-msg").text("Este campo es obligatorio.");
                } else if (RegExp.test(value)) {
                    $(input).removeClass("error").addClass("correct");
                    $(input).siblings(".error-msg").text("");
                } else {
                    $(input).removeClass("correct").addClass("error");
                    $(input).siblings(".error-msg").text("Solo se permiten letras y espacios.");
                }
            }




//                                function isUserName(event, input) {
//
//                                    let value = event.key;
//
//                                    let textoInput = $("#" + input.id).val() + value;
//                                    let RegExp = /^(?=[a-zA-Z0-9._]{5,20}$)(?!.*[_.]{2})[^_.].*[^_.]$/;
//
//                                    if (RegExp.test(textoInput)) {
//
//                                        $(input).removeClass("error").addClass("correct");
//                                        $(input).siblings(".error-msg").text("");
//
//                                    } else {
//
//                                        $(input).removeClass("correct").addClass("error");
//                                        $(input).siblings(".error-msg").text("Ingresa un usuario valido");
//                                    }
//                                }
//                                ;
//
//                                function SoloLetras(event, input) {
//                                    let value = event.key;
//
//                                    let textoInput = $("#" + input.id).val() + value;
//
//                                    let RegExp = /^[a-zA-ZÑñ\s]+$/;
//
//                                    if (RegExp.test(textoInput)) {
//
//                                        $(input).removeClass("error").addClass("correct");
//                                        $(input).siblings(".error-msg").text("");
//
//
//                                    } else {
//                                        $(input).removeClass("correct").addClass("error");
//                                        $(input).siblings(".error-msg").text("Este Campo Solo Permite Letras");
//                                        event.preventDefault();
//                                    }
//
//                                }
//                                ;
//
//                                function SoloNumeros(event, input) {
//
//                                    let value = event.key;
//
//                                    let textoInput = $("#" + input.id).val() + value;
//                                    let RegExp = /\+*([0-9]{2,3})*\s*[0-9]{10}/;
//
//                                    if (RegExp.test(textoInput)) {
//
//                                        $(input).removeClass("error").addClass("correct");
//                                        $(input).siblings(".error-msg").text("");
//
//                                    } else {
//
//                                        $(input).removeClass("correct").addClass("error");
//                                        $(input).siblings(".error-msg").text("Solo Se Permiten Digitos (0-9) Max: 10");
//
//                                    }
//
//                                }
//                                ;
//
//                                function isCURP(event, input) {
//
//                                    let value = event.key;
//
//                                    let textoInput = $("#" + input.id).val() + value;
//                                    let RegExp = /^([A-Z][AEIOUX][A-Z]{2}\d{2}(?:0[1-9]|1[0-2])(?:0[1-9]|[12]\d|3[01])[HM](?:AS|B[CS]|C[CLMSH]|D[FG]|G[TR]|HG|JC|M[CNS]|N[ETL]|OC|PL|Q[TR]|S[PLR]|T[CSL]|VZ|YN|ZS)[B-DF-HJ-NP-TV-Z]{3}[A-Z\d])(\d)$/;
//
//                                    if (RegExp.test(textoInput)) {
//
//                                        $(input).removeClass("error").addClass("correct");
//                                        $(input).siblings(".error-msg").text("");
//
//                                    } else {
//
//                                        $(input).removeClass("correct").addClass("error");
//                                        $(input).siblings(".error-msg").text("Ingresa un CURP valido");
//
//                                    }
//
//                                }
//                                ;
//
//                                function isEmail(event, input) {
//
//                                    let value = event.key;
//
//                                    let textoInput = $("#" + input.id).val() + value;
//                                    let RegExp = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
//
//                                    if (RegExp.test(textoInput)) {
//
//                                        $(input).removeClass("error").addClass("correct");
//                                        $(input).siblings(".error-msg").text("");
//
//                                    } else {
//
//                                        $(input).removeClass("correct").addClass("error");
//                                        $(input).siblings(".error-msg").text("Ingresa un Correo valido");
//
//                                    }
//
//                                }
//                                ;
//
//                                function isPassword(event, input) {
//
//                                    let value = event.key;
//
//                                    let textoInput = $("#" + input.id).val() + value;
//                                    let RegExp = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[$@$!%*?&])([A-Za-z\d$@$!%*?&]|[^ ]){8,15}$/;
//
//
//                                    if (RegExp.test(textoInput)) {
//
//                                        $(input).removeClass("error").addClass("correct");
//                                        $(input).siblings(".error-msg").text("");
//
//                                    } else {
//
//                                        $(input).removeClass("correct").addClass("error");
//                                        $(input).siblings(".error-msg").text("Ingresa una contraseña con al menos:\n\
//                                                                             mayuscula, miniscula, caracter especial\n\
//                                                                             con una longitud de 8 a 15 ");
//
//
//                                    }
//
//                                }
//                                ;
//
//                                function isFecha(input) {
//
//                                    let value = $(input).val();
//
//                                    let fechaIngresada = new Date(value);
//
//                                    let fechActual = new Date();
//
//                                    fechaIngresada.setHours(0, 0, 0, 0);
//                                    fechAcutal.setHours(0, 0, 0, 0);
//                                    if (fechaIngresada < fechaActual ){
//                                    console.log("La fecha no puede ser menor a hoy");
//                                    }                                  
//
//                                }



//                                function getval(sel)
//                                {
//                                    alert(sel.value);
//                                }
//                                ;
//


            const fotoInput = document.getElementById("imagenFile");
            const previewImg = document.getElementById('preview');

            fotoInput.addEventListener('change', e => {
                const file = fotoInput.files[0];
                if (!file)
                    return;

                if (!file.type.startsWith("image/")) {
                    Swal.fire({
                        icon: "error",
                        title: "Formato no válido",
                        text: "Selecciona solo imágenes (PNG, JPG, JPEG)."
                    });
                    fotoInput.value = "";
                    return;
                }


                previewImg.src = URL.createObjectURL(file);
            });


            let stream;
            const video = document.getElementById("video");
            const canvas = document.getElementById("canvas");
            const captureBtn = document.getElementById("captureBtn");
            const imagenFile = document.getElementById("imagenFile");

// Encender cámara al abrir modal
            document.getElementById("cameraModal").addEventListener("shown.bs.modal", async () => {
                try {
                    stream = await navigator.mediaDevices.getUserMedia({
                        video: {facingMode: "user"}
                    });
                    video.srcObject = stream;
                    await video.play();
                } catch (error) {
                    alert("No se puede acceder a la cámara, revisa permisos.");
                    console.error(error);
                }
            });

// Apagar cámara al cerrar modal
            document.getElementById("cameraModal").addEventListener("hidden.bs.modal", () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
            });

// Capturar foto
            captureBtn.addEventListener("click", () => {
                const ctx = canvas.getContext("2d");
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                previewImg.src = canvas.toDataURL("image/png");

                canvas.toBlob(blob => {
                    const file = new File([blob], "fotoUser.png", {
                        type: "image/png",
                        lastModified: Date.now()
                    });

                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    imagenFile.files = dataTransfer.files;
                }, "image/png", 0.6);

                bootstrap.Modal.getInstance(document.getElementById("cameraModal")).hide();
            });


        </script>

    </body>
</html>
